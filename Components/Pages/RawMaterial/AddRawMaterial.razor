@page "/rawmaterial/add"
@page "/rawmaterial/edit/{RmId:int}"

@attribute [Authorize]

@rendermode InteractiveServer

@using System.Security.Claims
@inject IToastService ToastService
@inject NavigationManager navigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject RawMaterialService rawMaterialService
@inject CategoryMasterServie categoryService
@inject SubCategoryMasterService subCategoryService
@inject VendorMasterService vendorMasterService


<FluentCard Width="100%" Height="300px" AreaRestricted="false" style="box-shadow: none;">

    <div class="d-flex justify-content-between align-items-center">
        <h3 class="fs-5">@(rawMaterial.Rmid != 0 ? "Update RM" : "Add RM")</h3>
    </div>

    <div class="container text-start">
        <div class="row row-cols-4 align-content-center">
            <div class="col">
                <FluentTextField @bind-Value=rawMaterial.Rmcode Label="Code" Placeholder="Enter raw material code"
                    Class="w-100" />
            </div>
            <div class="col">
                <FluentTextField @bind-Value=rawMaterial.Rmname Label="Raw Material" Placeholder="Enter raw material"
                    Class="w-100" />`
            </div>
            <div class="col">
                <FluentNumberField @bind-Value=rawMaterial.Price Label="Price" Placeholder="Enter raw material price"
                    Class="w-100" @oninput="@(e => rawMaterial.Price = Convert.ToDecimal(e.Value))" />
            </div>
            @* vendor *@
            <div class="col">
                <FluentSelect Height="300px" TOption="VendorMasterDto" Items="@vendorList"
                    @bind-Value="rawMaterial.Party" Label="Vendor" Placeholder="Select Vendor"
                    OptionText="@(c => c.VendorName)" OptionValue="@(c =>c.VendorName)" Class="w-100" />
            </div>

            <div class="col">
                <FluentTextField @bind-Value=rawMaterial.Description Label="Description" Placeholder="Enter description"
                    Class="w-100" />
            </div>
            <div class="col">
                <FluentTextField @bind-Value=rawMaterial.SpecificationNo Label="Specificiation"
                    Placeholder="Enter specification no..." Class="w-100" />
            </div>
            <div class="col">
                <FluentSelect Height="300px" TOption="CategoryMasterDto" Items="@categoryList"
                    @bind-Value="rawMaterial.CategoryName" Label="Category" Placeholder="Select Category"
                    OptionText="@(c => c.CategoryName)" OptionValue="@(c =>c.CategoryName)" Class="w-100"
                    @onchange="OnCategoryChange" />
            </div>

            <div class="col">
                <FluentSelect Height="300px" TOption="SubCategoryMasterDto" Items="@subCategoryList"
                    @bind-Value="rawMaterial.SubCategoryName" Label="Sub Category" Placeholder="Select Sub Category"
                    OptionText="@(c => c.SubCategoryName)" OptionValue="@(c =>c.SubCategoryName)" Class="w-100" />
            </div>

            <div class="co d-flex align-content-center align-items-end mt-4">
                <div class="col d-flex justify-content-start align-items-end">
                    <FluentSwitch @bind-Value=rawMaterial.IsNewRm Label="New Rm" Class="mb-1" />
                </div>
                <div class="col d-flex justify-content-start align-items-end">
                    <FluentSwitch @bind-Value=rawMaterial.IsDiscontinued Label="Discontinued" Class="mb-1" />
                </div>
            </div>
        </div>
        <div class="col d-flex justify-content-between align-items-start w-100 mt-2">
            <p class="text-danger" style="font-size: small; margin-left: 1rem; margin-top: 0.5rem;">@errorMessage</p>
            <FluentButton Loading="@isLoading" Appearance="Appearance.Accent" OnClick="@OnAddRawMaterial">
                @(rawMaterial.Rmid == 0 ? "Add" : "Update")
            </FluentButton>
        </div>
    </div>

</FluentCard>


@code {
    [CascadingParameter]
    public HttpContext? httpContext { get; set; } = default!;
    [Parameter]
    public int RmId { get; set; }

    private RmmasterDto rawMaterial = new RmmasterDto();
    private List<CategoryMasterDto> categoryList = new List<CategoryMasterDto>();
    private List<SubCategoryMasterDto> subCategoryList = new List<SubCategoryMasterDto>();
    private List<VendorMasterDto> vendorList = new List<VendorMasterDto>();
    private string errorMessage = string.Empty;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()

    {
        await LoadCategoryDataAsync();
        await LoadVendorDataAsync();
        await LoadSubCategoryDataAsync();

        if (RmId != 0)
        {
            await LoadRawMaterialDataAsync(RmId);
        }
    }

    private void OnAddRawMaterial()
    {
        try
        {
            isLoading = true;
            var user = AuthenticationStateProvider.GetAuthenticationStateAsync().Result.User;
            var userId = user?.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value;

            if (userId == null)
            {
                errorMessage = "User not found";
                isLoading = false;
                return;
            }

            rawMaterial.AddedBy = Guid.Parse(userId);
            rawMaterial.AddedOn = DateTime.Now;

            var category = categoryList.FirstOrDefault(c => c.CategoryName == rawMaterial.CategoryName);
            if (category == null)
            {
                errorMessage = "Category not found";
                isLoading = false;
                return;
            }
            rawMaterial.CategoryId = category.CategoryId;

            var subCategory = subCategoryList.FirstOrDefault(c => c.SubCategoryName == rawMaterial.SubCategoryName);
            if (subCategory == null)
            {
                errorMessage = "SubCategory not found";
                isLoading = false;
                return;
            }
            rawMaterial.SubCategoryId = subCategory.SubCategoryId;

            var vendor = vendorList.FirstOrDefault(c => c.VendorName == rawMaterial.Party);
            if (vendor == null)
            {
                errorMessage = "Vendor not found";
                isLoading = false;
                return;
            }
            rawMaterial.VendorId = vendor.VendorId;

            ApiResponse<RmmasterDto> response;
            if (rawMaterial.Rmid == 0)
            {
                response = rawMaterialService.AddRawMaterial(rawMaterial);
            }
            else
            {
                response = rawMaterialService.UpdateRawMaterial(rawMaterial);
            }

            if (response.Success)
            {
                ToastService.ShowSuccess("Raw Material added successfully");
            }
            else
            {
                errorMessage = response.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            // Log the exception or handle it accordingly
            errorMessage = ex.Message;
            ToastService.ShowError(errorMessage);
        }
        finally
        {
            isLoading = false;
        }
    }


    private void OnCategoryChange(ChangeEventArgs e)
    {
        try
        {
            if (e.Value == null)
            {
                return;
            }

            var category = e.Value.ToString();
            var categoryItem = categoryList.FirstOrDefault(c => c.CategoryName == category);

            if (categoryItem == null)
            {
                return;
            }

            var categoryId = int.Parse(categoryItem.CategoryId.ToString());
            var response = subCategoryService.GetSubCategoryMasterByCategory(categoryId);

            if (response.Success)
            {
                subCategoryList = response.Data;
            }
            else
            {
                errorMessage = response.ErrorMessage;
                ToastService.ShowError(errorMessage);
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            ToastService.ShowError(errorMessage);
        }
    }


    private async Task LoadCategoryDataAsync()
    {
        var response = await categoryService.GetCategoryMasterAsync();
        if (response.Success)
        {
            categoryList = response.Data;
        }
    }

    private async Task LoadVendorDataAsync()
    {
        var responseVendor = await vendorMasterService.GetVendorMasterAsync();
        if (responseVendor.Success)
        {
            vendorList = responseVendor.Data;
        }
    }

    private async Task LoadSubCategoryDataAsync()
    {
        var responseSubCategory = await subCategoryService.GetSubCategoryMasterAsync();
        if (responseSubCategory.Success)
        {
            subCategoryList = responseSubCategory.Data;
        }
    }

    private async Task LoadRawMaterialDataAsync(int rmId)
    {
        isLoading = true;
        var responseRawMaterial = await rawMaterialService.GetRawMaterialByIdAsync(rmId);

        if (responseRawMaterial.Success)
        {
            rawMaterial = responseRawMaterial.Data;
        }

        isLoading = false;
    }

}
