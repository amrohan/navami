@page "/rawmaterial"

@attribute [Authorize]

@using Microsoft.FluentUI.AspNetCore.Components
@using navami.Services
@using navami.Models
@inject IToastService ToastService
@inject NavigationManager navigationManager
@inject RawMaterialService rawMaterialService
@attribute [StreamRendering(true)]
@rendermode @(new InteractiveServerRenderMode(prerender:false))


<PageTitle>Raw Material</PageTitle>
<FluentCard Width="100%" Height="600px" style="box-shadow: none;">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h3 class="fs-5">Raw Material</h3>
        <FluentButton Appearance="Appearance.Accent" IconEnd="@(new Icons.Regular.Size16.Add())" OnClick="@AddCategory">
            Add
        </FluentButton>
    </div>
    <div class="d-flex justify-content-end align-items-center mb-1">
        <FluentSearch Placeholder="Search users..." Icon="Search" IconPosition="IconPosition.Start"
            @bind-Value=searchTerm @bind-Value:after=SearchRawMaterial Immediate=true />
    </div>
    @if (rawMaterialList == null)
    {
        <TableLoader />
    }
    else
    {

        <div style="height: 450px; overflow:auto;" class="border rounded">
            <FluentDataGrid Items="@rawMaterialList" GenerateHeader="GenerateHeaderOption.Sticky" Virtualize="true"
                ItemSize="43">
                <PropertyColumn Property="@(c=>c.RawMaterialCode)" Sortable="true" title="Code" />
                <PropertyColumn Property="@(c=>c.RawMaterialName)" Sortable="true" title="Raw Material" />
                <PropertyColumn Property="@(c=>c.Price)" Sortable="true" title="Price" />
                <PropertyColumn Property="@(c=>c.Party)" Sortable="true" title="Vendor" />
                <PropertyColumn Property="@(c=>c.Description)" Sortable="true" title="Description" />
                <PropertyColumn Property="@(c=>c.SpecificationNo)" Sortable="true" title="Specification" />
                <PropertyColumn Property="@(c=>c.CategoryName)" Sortable="true" title="Category" />
                <PropertyColumn Property="@(c=>c.SubCategoryName)" Sortable="true" title="Sub Category" />



                @* Actions *@
                <TemplateColumn Title="Actions" Align="@Align.End">
                    <FluentButton aria-label="Edit item" IconEnd="@(new Icons.Regular.Size16.Edit())"
                        OnClick="@(()=>EditRawMaterial(context) )" />
                    <FluentButton aria-label="Delete item" IconEnd="@(new Icons.Regular.Size16.Delete())"
                        OnClick="@(() => DeleteRecipeCategory(context))" />
                </TemplateColumn>
            </FluentDataGrid>
        </div>

    }
</FluentCard>


@code {
    private IQueryable<RawMaterialsDto> rawMaterialList;
    private IQueryable<RawMaterialsDto> originalRawMaterialList;

    string errorMessage = string.Empty;
    string searchTerm = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadRawMaterials();

    }


    private void AddCategory()
    {
        navigationManager.NavigateTo("/rawmaterial/add");
    }

    private void EditRawMaterial(RawMaterialsDto rawMaterial)
    {
        navigationManager.NavigateTo($"/rawmaterial/edit/{rawMaterial.RawMaterialId}");
    }

    private void SearchRawMaterial()
    {
        if (string.IsNullOrEmpty(searchTerm))
        {
            rawMaterialList = originalRawMaterialList;
        }
        else
        {
            rawMaterialList = originalRawMaterialList.Where(c => c.RawMaterialName.Contains(searchTerm));
        }
    }

    private void DeleteRecipeCategory(RawMaterialsDto rawMaterial)
    {
        var response = rawMaterialService.DeleteRawMaterial(rawMaterial.RawMaterialId);
        if (response.Success)
        {
            ToastService.ShowSuccess("Raw Material deleted successfully");
            rawMaterialList = rawMaterialList.Where(c => c.RawMaterialId != rawMaterial.RawMaterialId);
        }
        else
        {
            errorMessage = response.ErrorMessage;
            ToastService.ShowError(errorMessage);
        }
    }

    private async Task LoadRawMaterials()
    {
        var response = await rawMaterialService.GetAllRawMaterials();
        if (response.Success)
        {
            rawMaterialList = response.Data.AsQueryable();
            originalRawMaterialList = rawMaterialList;
        }
        else
        {
            errorMessage = response.ErrorMessage;
            ToastService.ShowError(errorMessage);
        }
    }
}